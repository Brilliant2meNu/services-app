<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Services Area</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            text-align: center;
            margin: 20px;
        }
        .button {
            display: inline-block;
            margin: 10px;
            padding: 10px 20px;
            font-size: 16px;
            color: #fff;
            background-color: #007BFF;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }
        .button:hover {
            background-color: #0056b3;
        }
        .green-button {
            background-color: #28a745;
        }
        .green-button:hover {
            background-color: #1e7e34;
        }
        #chatOutput {
            margin-top: 20px;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 5px;
            min-height: 50px;
        }
        #chatInput {
            width: 300px;
            padding: 10px;
            margin-top: 10px;
        }
    </style>
</head>
<body>
    <img src="JMK.jpg" alt="JMK Logo" style="width: 200px;">
    <h1>Services Area</h1>
    <div>
        <img src="keyboard-icon_v1.png" alt="Keyboard Icon" style="width: 50px; margin-right: 10px;">
        <img src="microphone-icon_v1.png" alt="Microphone Icon" style="width: 50px;">
    </div>
    <div id="services"></div>
    <button class="button green-button" onclick="generateQRCode()">Generate QR Code</button>
    <button class="button" onclick="login('admin@example.com', 'admin123')">Login as Admin</button>
    <button class="button" onclick="validateSession()">Validate Session</button>

    <!-- Chat Section -->
    <div>
        <button id="voiceButton" class="button">ðŸŽ¤ Speak</button>
        <input type="text" id="chatInput" placeholder="Type or use the mic...">
        <button id="sendButton" class="button">Send</button>
        <div id="chatOutput">Chat will appear here...</div>
    </div>

    <script type="module">
        // Import Supabase library
        import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';

        // Initialize Supabase
        const supabaseUrl = "https://ovmdpupofhhudxhitoov.supabase.co";
        const supabaseAnonKey = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im92bWRwdXBvZmhodWR4aGl0b292Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3Mzc0MjM1ODksImV4cCI6MjA1Mjk5OTU4OX0.c9cIXQHFL487yOG44XFfD2D672cPpYzK-AKoCiZpjnk";
        const supabase = createClient(supabaseUrl, supabaseAnonKey);

        // Fetch services from Supabase
        async function fetchServices() {
            const { data, error } = await supabase
                .from('service_offerings')
                .select('*');

            if (error) {
                console.error('Error fetching services:', error);
                return;
            }

            const servicesDiv = document.getElementById('services');
            servicesDiv.innerHTML = data.map(service => `
                <button class="button">${service.service_name}</button>
            `).join('');
        }

        // Function for QR code generation (Placeholder)
        function generateQRCode() {
            alert("QR Code generation coming soon!");
        }

        // Chatbot Login and Session Management
        const backendUrl = "https://services-app-k83k.vercel.app/api/auth";

        async function login(email, password) {
            const response = await fetch(`${backendUrl}/login`, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ email, password }),
            });
            const result = await response.json();
            if (response.ok) {
                localStorage.setItem("token", result.token);
                alert(`Welcome, ${result.role}!`);
            } else {
                alert(`Login failed: ${result.message}`);
            }
        }

        async function validateSession() {
            const token = localStorage.getItem("token");
            if (!token) {
                alert("No active session. Please log in.");
                return;
            }
            const response = await fetch(`${backendUrl}/validate-session`, {
                method: "POST",
                headers: { "Authorization": `Bearer ${token}` },
            });
            const result = await response.json();
            if (response.ok) {
                alert(`Session valid. Role: ${result.role}`);
            } else {
                alert(`Session invalid: ${result.error}`);
            }
        }

        // Voice Recognition and Chat
        const voiceButton = document.getElementById('voiceButton');
        const chatInput = document.getElementById('chatInput');
        const chatOutput = document.getElementById('chatOutput');
        const sendButton = document.getElementById('sendButton');

        voiceButton.addEventListener('click', () => {
            const recognition = new (window.SpeechRecognition || window.webkitSpeechRecognition)();
            recognition.lang = 'en-US';

            recognition.onresult = (event) => {
                const transcript = event.results[0][0].transcript;
                chatInput.value = transcript;
            };

            recognition.onerror = (err) => {
                console.error("Voice input error:", err);
                alert("Microphone access is needed!");
            };

            recognition.start();
        });

        sendButton.addEventListener('click', async () => {
            const userInput = chatInput.value;
            const response = await fetchGPTResponse(userInput);
            chatOutput.innerText = response;
        });

        async function fetchGPTResponse(userInput) {
            const response = await fetch("https://api.openai.com/v1/chat/completions", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                    "Authorization": `Bearer ${process.env.OPENAI_API_KEY}`
                },
                body: JSON.stringify({
                    model: "gpt-4",
                    messages: [
                        { role: "system", content: "You are a helpful beauty assistant." },
                        { role: "user", content: userInput }
                    ]
                })
            });
            const data = await response.json();
            return data.choices[0].message.content;
        }

        // Fetch services on page load
        fetchServices();
    </script>
</body>
</html>
